<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>StarWars.Run - People</title>
  <link rel="preload" href="/css/bulma.min.css" as="style">
  <link rel="stylesheet" href="/css/bulma.min.css">
  <script type="module" src="/components/Header.js"></script>

  <meta name="description" content="Explore all the starwars people. Darth Vader, Luke Skywalker, Han Solo, 3CPO, R2D2, Anakin Skywalker, 
    Princess Leia Organa, Owen Lars, Obi-Wan Kenobi, Yoda, Wedge Antilles, Jengo Fett, Bobba Fett, Senator Palpatine, 
    PadmÃ© Amidala, Darth Maul">
</head>

<body>
  <main>
    <section class="section">
      <nav id="main-nav" class="navbar"></nav>
      <div id="header"></div>
      <div class="content">
        <input class="input" id="search-input" type="text" placeholder="Search for a Person" data-entity="people"
          data-search-term="a">
      </div>
      <div class="content">
        <div id="search-header"></div>
        <div id="search-results"></div>
      </div>
    </section>
  </main>

  <script type="module">
    import { html, render } from '/scripts/htm.standalone.module.js';

    import { fromEvent, from, combineLatest } from "https://cdn.skypack.dev/rxjs";
    import {
      tap,
      map,
      debounceTime,
      scan,
      filter,
      distinctUntilChanged,
    } from "https://cdn.skypack.dev/rxjs/operators";


    import { SearchResultsHeader } from '/components/SearchResultsHeader.js';
    import { SearchResultsContent } from '/components/SearchResultsContent.js';

    import { fetchSearchResults, SET_SEARCH_RESULTS } from '/redux/actions/search.js';

    import { Nav } from '/components/Nav.js';
    import { Header } from '/components/Header.js';

    render(html`<${Nav} active_label="people"/>`, document.getElementById("main-nav"));
    render(html`<${Header} />`, document.getElementById("header"));
    const payload = {
      searchTerm: "Please enter a seearch Term", count: 0, results: [
        { name: "luke", title: "jedi" }, { name: "han", title: "outlaw" }
      ]
    };

    const searchTermInput = document.getElementById("search-input");

    const userSearchInput$ = fromEvent(searchTermInput, "keyup").pipe(
      map(e => e.target.value),
      filter(v => v.length >= 1),
      debounceTime(750),
      distinctUntilChanged(),
    );


    if (window.Worker) {
      const search_worker = new Worker("/worker.js", { type: "module", name: "search-worker" });

      //send default search for Skywalker
      userSearchInput$.subscribe(e => {
        //save the data-search-term
        searchTermInput.setAttribute("data-search-term", e);

        const { entity, searchTerm } = searchTermInput.dataset;
        //execution action creator to post message to worker
        const evt = fetchSearchResults({ searchTerm: e, entity, page: 1 });
        search_worker.postMessage(evt);
      });

      //publish a default message
      const evt = fetchSearchResults({ searchTerm: "a", entity: "people", page: 1 });
      search_worker.postMessage(evt);

      //script the HTML output
      //once worker processes event, respond to output event
      search_worker.onmessage = (e) => {
        const { payload } = e?.data;
        const paginationHandler = (e) => {
          const { page } = e.target.dataset;
          //publish a default message
          const evt = fetchSearchResults({ searchTerm: "a", entity: "people", page});
          search_worker.postMessage(evt);
          // var phOutput$ = from([e]).pipe(
          //   map(e => e.target.dataset.page),
          //   tap(payload => console.log("pagination handleer event stream", payload))
          // );
        };
        console.log("from worker", payload, paginationHandler);

        render(html`<${SearchResultsHeader} payload="${payload}" paginationHandler="${paginationHandler}"/>`, document.getElementById("search-header"));
        render(html`<${SearchResultsContent} payload="${payload}"/>`, document.getElementById("search-results"));
      };

      var searchResultWorkerOutput$ = fromEvent(search_worker, "message").pipe(
        map(e => e.data),
        filter(event => event.type.includes(SET_SEARCH_RESULTS)),
        map(event => event.payload),
        tap(payload => console.log("worker output event stream", payload))
      );

      searchResultWorkerOutput$.subscribe((data) => console.log("search sub", data));
    }

  </script>
</body>

</html>